#!/bin/bash
name=`basename "$0"`
if [ $name = bspcxx ]; then
  cc=@MPI_CXX_COMPILER@
else
  cc=@MPI_C_COMPILER@
fi
cxx=@MPI_CXX_COMPILER@
bsponmpi="@BSPONMPI_LIB@"
cflags="-I@BSPONMPI_INCLUDE@"

linking=yes
read_sources=no
read_output=no
read_linker=no
show=

objdir=
sources=()
tmp_objects=()
objects=()
compile_flags=()
link_flags=()
output_flag=()

function onexit_clean()
{
    if [ "x${objdir}" != x ]; then
      rm -r "$objdir"
    fi
}

trap onexit_clean EXIT


function add_source_or_object()
{
    case $1 in
        *.o ) objects=( "${objects[@]}" "$1" )
              ;;
        *) sources=( "${sources[@]}" "$1" )
            ;;
    esac
} 

function add_compile_flag()
{
    compile_flags=( "${compile_flags[@]}" "$1" )
}

function add_link_flag()
{
    link_flags=( "${link_flags[@]}" "$1" )
} 


for arg
do

  case $arg in

    -show) show=echo
        ;;

    -c) linking=no
        add_compile_flag "$arg"
        ;;

    -o) read_output=yes
        ;;

    --) read_sources=yes
        add_compile_flag "$arg"
        ;;

    -l*)   add_link_flag "$arg"
        ;;

    -Wl,*) add_link_flag "$arg"
        ;;

    -Xlinker) add_link_flag "$arg"
           read_linker=yes
        ;;

    -*) if [ x$read_linker = "xyes" ]; then
          add_link_flag "$arg"
          read_linker=no
        elif [ x$read_output = "xyes" ]; then
          output_flag=("-o" "$arg" )
          read_output=no
        elif [ x$read_sources = xyes ]; then
          add_source_or_object "$arg"
        else
          add_compile_flag "$arg"
        fi
        ;;
    
    *)  if [ x$read_linker = "xyes" ]; then
          add_link_flag "$arg"
          read_linker=no
        elif [ x$read_output = "xyes" ]; then
          output_flag=("-o" "$arg" )
          read_output=no
        else
          add_source_or_object "$arg"
        fi
        ;;
  esac
done


if [ x$linking = xno ]; then
  $show $cc $cflags  "${compile_flags[@]}" \
         "${sources[@]}" "${objects[@]}" \
         "${link_flags[@]}" "${output_flag[@]}"
  exit_status=$?
else

  objdir=`mktemp -d`
  objnum=1
  for s in "${sources[@]}"
  do
    obj="${objdir}/${objnum}.o"
    objnum=$(( objnum + 1 ))
    tmp_objects=( "${tmp_objects[@]}" "$obj" )
    $show $cc $cflags "${compile_flags[@]}" "$s" -c -o "$obj" || { exit $?; }
  done

  $show $cxx $cflags "${compile_flags[@]}" \
           "${tmp_objects[@]}" "${objects[@]}" \
           "${link_flags[@]}" $bsponmpi "${output_flag[@]}"
  exit_status=$?
fi

exit $exit_status
